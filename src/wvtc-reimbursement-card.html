<!--
@license
Copyright (c) 2016 The Polymer Project Authors.
Copyright (c) 2017 West Valley Track Club, Inc.
All rights reserved.
This code may only be used under the BSD style license found at http://polymer.github.io/LICENSE.txt
The complete set of authors may be found at http://polymer.github.io/AUTHORS.txt
The complete set of contributors may be found at http://polymer.github.io/CONTRIBUTORS.txt
Code distributed by Google as part of the polymer project is also
subject to an additional IP rights grant found at http://polymer.github.io/PATENTS.txt
-->

<link rel="import" href="../bower_components/iron-collapse/iron-collapse.html">
<link rel="import" href="../bower_components/iron-icons/iron-icons.html">
<link rel="import" href="../bower_components/paper-button/paper-button.html">
<link rel="import" href="../bower_components/paper-card/paper-card.html">
<link rel="import" href="../bower_components/paper-datatable/paper-datatable.html">
<link rel="import" href="../bower_components/paper-datatable/paper-datatable-column.html">
<link rel="import" href="../bower_components/paper-dropdown-menu/paper-dropdown-menu.html">
<link rel="import" href="../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../bower_components/paper-input/paper-input.html">
<link rel="import" href="../bower_components/paper-item/paper-item.html">
<link rel="import" href="../bower_components/paper-listbox/paper-listbox.html">
<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="../bower_components/polymerfire/firebase-document.html">
<link rel="import" href="shared-styles.html">
<link rel="import" href="wvtc-reimbursement-pref.html">

<dom-module id="wvtc-reimbursement-card">
  <template>
    <style include="shared-styles">
      #card {
        --paper-card-content: {
          padding-top: 0;
        };
        --paper-card-header-image: {
          min-width: 280px;
          max-width: 480px;
          margin: auto;
        };
      }

      .form {
        padding: 0 8px 16px;
        @apply(--layout-horizontal);
        @apply(--layout-end);
      }

      .races {
        flex: 3 3 160px;
        padding-right: 16px;
      }

      .amount {
        flex: 1 1 48px;
        padding-right: 16px;
      }

      .request {
        flex: 0 0 auto;
        color: white;
        background-color: var(--primary-color);
      }

      .buttons {
        @apply(--layout-horizontal);
        @apply(--layout-justified);
      }

      .toggle {
        opacity: var(--dark-secondary-opacity);
        margin-right: 8px;
      }

      .preferences {
        padding: 0 16px 16px;
      }
    </style>

    <firebase-document
        app-name="wvtc"
        path="/races/2017/road"
        data="{{_roadRaces}}">
    </firebase-document>
    <firebase-document
        app-name="wvtc"
        path="/races/2017/xc"
        data="{{_xcRaces}}">
    </firebase-document>
    <firebase-document
        id="reimbursements"
        app-name="wvtc"
        path="/reimbursements/2017/[[user.uid]]"
        data="{{_reimbursements}}">
    </firebase-document>

    <paper-card id="card" class="wvtc-card" image="../images/logos/pausatf.png">
      <div class="card-content">
        <p>Members in good standing are eligible for PA race reimbursement</p>
        <p hidden$="[[!_isActiveMember(membership)]]">
          <em>Deadlines to file requests are July 15 and December 15</em>
        </p>
        <div class="form" hidden$="[[!_isActiveMember(membership)]]">
          <paper-dropdown-menu class="races" label="Race">
            <paper-listbox
                class="dropdown-content"
                selected="{{selectedRace}}"
                attr-for-selected="race">
              <template is="dom-repeat" items="{{eligibleRaces}}" as="race">
                <paper-item race="[[race]]">{{race.name}}</paper-item>
              </template>
            </paper-listbox>
          </paper-dropdown-menu>
          <paper-input
              class="amount"
              label="Amount"
              value="{{_formatAmount(selectedRace.amount)}}"
              readonly>
          </paper-input>
          <paper-button
              class="request"
              on-tap="_requestReimbursement"
              raised
              disabled="[[!selectedRace]]">
            Request
          </paper-button>
        </div>
        <paper-datatable
            hidden$="{{_hasRequestedReimbursements(_reimbursements.*)}}"
            data="{{reimbursementRequests}}"
            resize-behavior="overflow">
          <paper-datatable-column header="Race" property="race">
          </paper-datatable-column>
          <paper-datatable-column
              header="Amount"
              property="amount"
              type="Number">
            <template>{{_formatAmount(value)}}</template>
          </paper-datatable-column>
          <paper-datatable-column header="Status" property="status">
          </paper-datatable-column>
        </paper-datatable>
      </div>
      <div class="card-actions">
        <div class="buttons">
          <paper-button toggles="{{opened}}" on-tap="toggleOpened">
            Preferences
          </paper-button>
          <paper-icon-button
              class="toggle"
              icon="[[_toggleIcon]]"
              on-tap="toggleOpened">
          </paper-icon-button>
        </div>
        <iron-collapse class="preferences" opened={{opened}}>
          <p>Choose how race registration fees are reimbursed</p>
          <wvtc-reimbursement-pref user="[[user]]"></wvtc-reimbursement-pref>
        </iron-collapse>
      </div>
    </paper-card>
  </template>

  <script>
    Polymer({
      is: 'wvtc-reimbursement-card',
      properties: {
        user: Object,
        membership: Object,
        allRaces: {
          type: Array,
          computed: '_computeAllRaces(_xcRaces, _roadRaces)'
        },
        eligibleRaces: {
          type: Array,
          computed: '_computeEligibleRaces(allRaces, _reimbursements.*)'
        },
        selectedRace: {
          type: Object,
          value: function() {
            return null;
          }
        },
        reimbursementRequests: {
          type: Array,
          computed: '_computeReimbursementRequests(allRaces, _reimbursements.*)'
        },
        _xcRaces: Object,
        _roadRaces: Object,
        _reimbursements: Object,
        _toggleIcon: {
          type: String,
          computed: '_computeToggleIcon(opened)'
        },
      },
      _computeAllRaces: function(xcRaces, roadRaces) {
        var toSimplifiedRace = function(races) {
          return function(id) {
            var race = races[id];
            return {
              id: id,
              name: race.name,
              date: race.date,
              amount: race.reimbursementAmount
            };
          };
        };
        var xc = Object.keys(xcRaces).map(toSimplifiedRace(xcRaces));
        var road = Object.keys(roadRaces).map(toSimplifiedRace(roadRaces));
        return xc.concat(road);
      },
      _computeEligibleRaces: function(allRaces, reimbursements) {
        var compareByDate = function(race1, race2) {
          if (race1.date < race2.date) {
            return -1;
          }
          if (race1.date > race2.date) {
            return 1;
          }
          return 0;
        };
        var isPast = function(race) {
          var now = new Date();
          return race.date < now.toJSON();
        };
        var hasNotBeenRequested = function(race) {
          return !reimbursements.base.hasOwnProperty(race.id);
        };

        return allRaces.sort(compareByDate)
                       .filter(isPast)
                       .filter(hasNotBeenRequested);
      },
      _computeReimbursementRequests: function(allRaces, reimbursements) {
        var hasRequestedReimbursement = function(race) {
          return reimbursements.base.hasOwnProperty(race.id);
        };
        var toReimbursementRequest = function(race) {
          var request = reimbursements.base[race.id];
          return {
            race: race.name,
            requestedOn: request.requestedOn,
            amount: race.amount,
            status: request.status
          };
        };

        return allRaces.filter(hasRequestedReimbursement)
                       .map(toReimbursementRequest);
      },
      _hasRequestedReimbursements: function(reimbursements) {
        return this.$.reimbursements.valueIsEmpty(reimbursements.base);
      },
      _formatAmount: function(amount) {
        if (!amount) {
          return '';
        }
        return '$' + (amount / 100);
      },
      _requestReimbursement: function() {
        var race = this.selectedRace;
        var now = new Date();
        this.set('_reimbursements.' + race.id, {
          requestedOn: now.toJSON(),
          status: 'Pending'
        });
        this.selectedRace = null;
      },
      toggleOpened: function() {
        this.opened = !this.opened;
      },
      _computeToggleIcon: function(opened) {
        return opened ? 'icons:expand-less' : 'icons:expand-more';
      },
      _isActiveMember: function(membership) {
        return !!membership.paidOn;
      },
    });
  </script>
</dom-module>
